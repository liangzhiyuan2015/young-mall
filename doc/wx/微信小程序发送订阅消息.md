# 微信小程序发送订阅消息

## 前言：

​	微信小程序，模版消息已经不再支持，改为使用 订阅消息。

## 一、首先要在添加一个订阅消息模板

### 1.1 登陆上微信小程序的[后台](https://mp.weixin.qq.com/wxamp/newtmpl/mytmpl)，选择订阅消息

<img src="png\订阅位置.png" alt="订阅位置" style="zoom:50%;" />

### 1.2 在`公共模板库`选择适合的模板，这里以`退款为例`

<img src="png\消息模板.png" alt="消息模板" style="zoom:50%;" />

### 1.3 选择自己订阅消息需要的字段

<img src="png\订阅消息详情png.png" alt="订阅消息详情png" style="zoom:50%;" />

### 1.4 然后可以得到模板ID

<img src="png\模板id.png" alt="模板id" style="zoom:50%;" />



模板中字段定义：

```json
详细内容
订单号
{{character_string3.DATA}}

退款金额
{{amount2.DATA}}

客户名称
{{thing1.DATA}}
```



## 二、给小程序端添加获取权限代码

这里可以参考[官方](https://developers.weixin.qq.com/miniprogram/dev/api/open-api/subscribe-message/wx.requestSubscribeMessage.html)文档，把获取权限的代码写入到点击事件中

```js
wx.requestSubscribeMessage({
  tmplIds: [''],
  success (res) { }
})
```

可以使用退款按钮js代码中添加此提示

```js
  // “取消订单并退款”点击效果
  refundOrder: function (e) {
    let that = this;
    let orderId = e.currentTarget.dataset.index;
    wx.requestSubscribeMessage({
      tmplIds: ['需要订阅的消息模板的id的集合'],
      success: (res) =>{
        console.log("订阅消息权限获取"+JSON.stringify(res))
      }
    });
    wx.showModal({
      title: '',
      content: '确定要取消此订单？',
      success: function (res) {
        if (res.confirm) {
          util.request(api.OrderRefund, {
            orderId: orderId
          }, 'POST').then(function (res) {
            if (res.code === 200) {
              wx.showToast({
                title: '取消订单成功'
              });
              util.redirect('/pages/ucenter/order/order');
            } else {
              util.showErrorToast(res.msg);
            }
          });
        }
      }
    });
  },
```

<img src="png\小程序弹窗.png" alt="小程序弹窗" style="zoom:80%;" />

## 三、后端发送订阅消息

这里可以参考[官方文档](https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/subscribe-message/subscribeMessage.send.html)

### 3.1 官方给的api地址：

```http
POST https://api.weixin.qq.com/cgi-bin/message/subscribe/send?access_token=ACCESS_TOKEN
```

`api`中的ACCESS_TOKEN需要提前获取

### 3.2 获取ACCESS_TOKEN

获取方法：

```http
GET https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=APPID&secret=APPSECRET
```

暂时使用postman测试：

<img src="png\ACCESSS_TOKEN.png" alt="ACCESSS_TOKEN" style="zoom:70%;" />

### 3.3 发送消息

使用获取到的ACCESS_TOKEN发送消息：

入参：

```json
{
  "touser": "接收者（用户）的 openid",
  "template_id": "模板ID",
  "page": "index",
  "miniprogram_state":"developer",
  "lang":"zh_CN",
  "data": {
      "character_string3": {
          "value": "339208499"
      },
      "amount2": {
          "value": "188"
      },
      "thing1": {
          "value": "TIT创意园"
      }
  }
}
```



<img src="png\发送订阅消息.png" alt="发送订阅消息" style="zoom:70%;" />